# ==========================
# MinDoc 生产级 Compose 文件
# ==========================
# 业务探活注释：脚本会读取下面两行
# HEALTH_PORT=10004
# HEALTH_PATH=/login
#
# 日志落盘：使用 local 驱动 + 卷挂载
# 宿主机路径：/home/dockerlog/mindoc/container.log
# ==========================

services:
  mindoc:
    image: registry.cn-hangzhou.aliyuncs.com/mindoc-org/mindoc:v2.1
    container_name: mindoc
    privileged: false
    restart: always
    ports:
      - "10004:8181"
    volumes:
      - /home/mindoc/conf:/mindoc/conf
      - /home/mindoc/database:/mindoc/database
      - /home/mindoc/runtime:/mindoc/runtime
      - /home/mindoc/static:/mindoc/static
      - /home/mindoc/views:/mindoc/views
      - /home/mindoc/uploads:/mindoc/uploads
      # 日志持久化
      - /home/dockerlog/mindoc:/var/log/mindoc

    environment:
      - MINDOC_RUN_MODE=prod
      - MINDOC_DB_ADAPTER=sqlite3
      - MINDOC_DB_DATABASE=./database/mindoc.db
      - MINDOC_BASE_URL=
      - MINDOC_ENABLE_EXPORT=true
      - MINDOC_EXPORT_PROCESS_NUM=1
      - MINDOC_EXPORT_LIMIT_NUM=5
      - MINDOC_EXPORT_QUEUE_LIMIT_NUM=100
      - MINDOC_EXPORT_OUTPUT_PATH=./runtime/cache

    # -------------------------------------------------
    # 健康检查
    # -------------------------------------------------
    healthcheck:
      test: ["CMD-SHELL", "curl -k -f http://localhost:8181/login || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    # -------------------------------------------------
    # 日志落盘配置：local 驱动
    # -------------------------------------------------
    logging:
      driver: "local"
      options:
        max-size: "100m"
        max-file: "5"
